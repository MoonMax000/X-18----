# Composer Phase 3 - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

**–î–∞—Ç–∞:** 09.11.2025  
**–°—Ç–∞—Ç—É—Å:** –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

---

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

1. **–ö–æ–¥ –∑–∞–ø—É—à–µ–Ω –≤ main:** Commit `c41f3af8`
2. **–î–µ–ø–ª–æ–π –∑–∞–ø—É—â–µ–Ω:** GitHub Actions workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
3. **–°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤:** `apply-composer-migration.sh`

---

## üóÑÔ∏è –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∫ –ë–î

### –í–∞—Ä–∏–∞–Ω—Ç A: –ò—Å–ø–æ–ª—å–∑—É—è —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
./apply-composer-migration.sh
```

–°–∫—Ä–∏–ø—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç:
- Database host
- Database user (default: postgres)
- Database name (default: x18_production)
- Password (—á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `DB_PASSWORD`)

### –í–∞—Ä–∏–∞–Ω—Ç B: –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ psql

```bash
# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
export DB_HOST="your-db-host.rds.amazonaws.com"
export DB_USER="postgres"
export DB_NAME="x18_production"
export DB_PASSWORD="your-password"

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
psql -h $DB_HOST -U $DB_USER -d $DB_NAME -f custom-backend/internal/database/migrations/024_add_access_control_fields.sql
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è:

- –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É `access_level` (varchar(30), default 'free')
- –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É `reply_policy` (varchar(30), default 'everyone')
- –°–æ–∑–¥–∞—ë—Ç –∏–Ω–¥–µ–∫—Å –Ω–∞ `access_level`
- –î–æ–±–∞–≤–ª—è–µ—Ç constraints –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ—Å—Ç—ã —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

---

## üß™ –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π backend

```bash
cd custom-backend
go run cmd/server/main.go
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ frontend

```bash
npm run dev
```

### 3. –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

#### A. Free Post (default)
1. –û—Ç–∫—Ä–æ–π—Ç–µ QuickComposer
2. –ù–∞–ø–∏—à–∏—Ç–µ –ø–æ—Å—Ç
3. –ù–µ –º–µ–Ω—è–π—Ç–µ access settings (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å free –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ—Å—Ç
5. **–û–∂–∏–¥–∞–Ω–∏–µ:** –ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω —Å `access_level = 'free'`, `reply_policy = 'everyone'`

#### B. Pay-per-post
1. –û—Ç–∫—Ä–æ–π—Ç–µ QuickComposer
2. –ù–∞–ø–∏—à–∏—Ç–µ –ø–æ—Å—Ç
3. –í—ã–±–µ—Ä–∏—Ç–µ "Pay-per-post" –≤ access settings
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ü–µ–Ω—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, $9.99)
5. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ—Å—Ç
6. **–û–∂–∏–¥–∞–Ω–∏–µ:** –ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω —Å `access_level = 'pay-per-post'`, `price_cents = 999`

#### C. Pay-per-post –±–µ–∑ —Ü–µ–Ω—ã (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞)
1. –û—Ç–∫—Ä–æ–π—Ç–µ QuickComposer
2. –ù–∞–ø–∏—à–∏—Ç–µ –ø–æ—Å—Ç
3. –í—ã–±–µ—Ä–∏—Ç–µ "Pay-per-post"
4. –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ —Ü–µ–Ω—É
5. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
6. **–û–∂–∏–¥–∞–Ω–∏–µ:** –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ "pay-per-post requires a price greater than 0"

#### D. Subscribers-only
1. –û—Ç–∫—Ä–æ–π—Ç–µ QuickComposer
2. –ù–∞–ø–∏—à–∏—Ç–µ –ø–æ—Å—Ç
3. –í—ã–±–µ—Ä–∏—Ç–µ "Subscribers-only"
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ—Å—Ç
5. **–û–∂–∏–¥–∞–Ω–∏–µ:** –ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω —Å `access_level = 'subscribers-only'`

#### E. Reply Policy
1. –û—Ç–∫—Ä–æ–π—Ç–µ QuickComposer
2. –ù–∞–ø–∏—à–∏—Ç–µ –ø–æ—Å—Ç
3. –ò–∑–º–µ–Ω–∏—Ç–µ reply policy (everyone / following / verified / mentioned)
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ—Å—Ç
5. **–û–∂–∏–¥–∞–Ω–∏–µ:** –ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `reply_policy`

---

## üåê –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production

### –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ health endpoint:**
   ```bash
   curl https://your-api-domain.com/health
   ```

2. **–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç —á–µ—Ä–µ–∑ UI:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ production app
   - –ó–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å
   - –°–æ–∑–¥–∞–π—Ç–µ –ø–æ—Å—Ç —á–µ—Ä–µ–∑ QuickComposer
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ—Å—Ç —Å–æ–∑–¥–∞–ª—Å—è

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î –Ω–∞–ø—Ä—è–º—É—é:**
   ```sql
   SELECT id, content, access_level, reply_policy, price_cents 
   FROM posts 
   ORDER BY created_at DESC 
   LIMIT 5;
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ—Å—Ç—ã:**
   ```sql
   -- –î–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
   SELECT COUNT(*) FROM posts WHERE access_level = 'free';
   SELECT COUNT(*) FROM posts WHERE reply_policy = 'everyone';
   ```

---

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: "column access_level already exists"
**–†–µ—à–µ–Ω–∏–µ:** –ú–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —à–∞–≥

### –ü—Ä–æ–±–ª–µ–º–∞: Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 500 –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞
**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
2. –ù–µ–≤–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ access_level - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å payload
3. Pay-per-post –±–µ–∑ —Ü–µ–Ω—ã - –¥–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—É

### –ü—Ä–æ–±–ª–µ–º–∞: Frontend –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è
**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. buildPostPayload –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –º–∞–ø–ø–∏—Ç –ø–æ–ª—è
2. API client –æ–±–Ω–æ–≤–ª–µ–Ω
3. Frontend –∑–∞–¥–µ–ø–ª–æ–µ–Ω

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CloudWatch logs:

```bash
# –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏ backend
aws logs tail /aws/ecs/x18-backend --follow

# –ò—â–µ–º –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤
aws logs filter-pattern "[CreatePost ERROR]" /aws/ecs/x18-backend
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏:

1. **POST /api/posts/** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö vs –æ—à–∏–±–æ–∫
2. **Latency** - —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
3. **Error rate** - –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫ 4xx/5xx

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ production

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ production –ë–î
- [ ] Backend –∑–∞–¥–µ–ø–ª–æ–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ health checks
- [ ] Frontend –∑–∞–¥–µ–ø–ª–æ–µ–Ω
- [ ] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ—Å—Ç—ã –ø–æ–ª—É—á–∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ free –ø–æ—Å—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ pay-per-post —Å —Ü–µ–Ω–æ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ—à–∏–±–∫–∞ –ø—Ä–∏ pay-per-post –±–µ–∑ —Ü–µ–Ω—ã)
- [ ] –í—Å–µ 5 —Ç–∏–ø–æ–≤ access_level –¥–æ—Å—Ç—É–ø–Ω—ã
- [ ] –í—Å–µ 4 —Ç–∏–ø–∞ reply_policy –¥–æ—Å—Ç—É–ø–Ω—ã
- [ ] Backward compatibility: —Å—Ç–∞—Ä—ã–µ –ø–æ—Å—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç —Å –ª—é–±—ã–º –∏–∑ 5 —Ç–∏–ø–æ–≤ access
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å reply policy
- ‚úÖ Pay-per-post —Ç—Ä–µ–±—É–µ—Ç —Ü–µ–Ω—É > 0
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ backend
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç (backward compatibility)

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ Constraints —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è
- ‚úÖ Payload –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –º–∞–ø–ø–∏—Ç—Å—è

### Performance:
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ < 500ms
- ‚úÖ Error rate < 1%
- ‚úÖ –ò–Ω–¥–µ–∫—Å –Ω–∞ access_level —É–ª—É—á—à–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ CloudWatch
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –ë–î
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ payload –≤ Network tab –±—Ä–∞—É–∑–µ—Ä–∞
4. –û—Ç–∫–∞—Ç–∏—Ç–µ—Å—å –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ:** `COMPOSER_RESEARCH_SUMMARY.md`
- **–û—Ç—á—ë—Ç –§–∞–∑—ã 3:** `COMPOSER_PHASE3_COMPLETE.md`
- **–ú–∏–≥—Ä–∞—Ü–∏—è:** `custom-backend/internal/database/migrations/024_add_access_control_fields.sql`
- **–°–∫—Ä–∏–ø—Ç:** `apply-composer-migration.sh`

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –§–∞–∑–∞ 4 - –ü–æ–ª–Ω–æ–µ E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 09.11.2025*  
*–ê–≤—Ç–æ—Ä: Cline AI Assistant*
