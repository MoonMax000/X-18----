# üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Stripe - –ó–∞–≤–µ—Ä—à–µ–Ω–∞

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã Stripe –∫–ª—é—á–∏ –≤ `.env` —Ñ–∞–π–ª—ã:
  - **Publishable key**: `pk_test_51SAAyA5L1ldpQtHXqPMjNzmJgC66HaczmaGiBFvvqMbdjeGyTsEJAo740wyBphurUdTn7nWJLoscP48ICxklGRLp00tOkeCiOE`
  - **Secret key**: –ù–∞—Å—Ç—Ä–æ–µ–Ω –≤ `custom-backend/.env`
  - **Frontend**: –ö–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ `client/.env.local`

### 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `027_add_stripe_and_purchases.sql`
- ‚úÖ –¢–∞–±–ª–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã:
  - `post_purchases` - –ø–æ–∫—É–ø–∫–∏ –ø–æ—Å—Ç–æ–≤
  - `subscriptions` - –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∞–≤—Ç–æ—Ä–æ–≤
  - `payment_history` - –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

### 3. Backend (Go)
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Stripe SDK
- ‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `internal/api/stripe_handlers.go` —Å –º–µ—Ç–æ–¥–∞–º–∏:
  - `CreatePaymentIntent` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
  - `HandleStripeWebhook` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤
  - `CheckPostAccess` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Å—Ç—É
  - `GetUserPurchases` - –∏—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫
  - `GetUserSubscriptions` - –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
  - `CancelSubscription` - –æ—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏

- ‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `internal/models/monetization.go` —Å –º–æ–¥–µ–ª—è–º–∏:
  - `PostPurchase` - –º–æ–¥–µ–ª—å –ø–æ–∫—É–ø–∫–∏ –ø–æ—Å—Ç–∞
  - `Subscription` - –º–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏
  - `PaymentHistory` - –º–æ–¥–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π

### 4. Frontend (React)
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
  - `@stripe/stripe-js`
  - `@stripe/react-stripe-js`

- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ:
  - `PaymentModal` - –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã
  - `FollowModal` - –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥–ø–∏—Å–∫–∏
  - `LockedPostPlaceholder` - –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–ª–∞—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

## üìã API Endpoints

### –ü–ª–∞—Ç–µ–∂–∏
- `POST /api/stripe/payment-intent` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
- `POST /api/stripe/webhook` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç Stripe
- `GET /api/posts/:id/access` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Å—Ç—É
- `GET /api/user/purchases` - —Å–ø–∏—Å–æ–∫ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
- `GET /api/user/subscriptions` - —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- `DELETE /api/subscriptions/:id` - –æ—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏

## üöÄ –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ

1. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã**:
   ```bash
   # Backend (.env)
   STRIPE_SECRET_KEY=sk_test_...
   STRIPE_WEBHOOK_SECRET=whsec_... # –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞
   
   # Frontend (.env.local)
   VITE_STRIPE_PUBLISHABLE_KEY=pk_test_...
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**:
   ```bash
   ./START_CUSTOM_BACKEND_STACK.sh
   ```

3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Stripe CLI –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –≤–µ–±—Ö—É–∫–æ–≤** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```bash
   # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Stripe CLI
   brew install stripe/stripe-cli/stripe
   
   # –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç
   stripe login
   
   # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤—å—Ç–µ –≤–µ–±—Ö—É–∫–∏ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
   stripe listen --forward-to localhost:8080/api/stripe/webhook
   
   # –°–∫–æ–ø–∏—Ä—É–π—Ç–µ webhook secret –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ .env
   ```

## üí≥ –¢–∏–ø—ã –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏

### 1. Pay-per-post (–ü–ª–∞—Ç–Ω—ã–µ –ø–æ—Å—Ç—ã)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–ª–∞—Ç—è—Ç –∑–∞ –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ—Å—Ç—É
- –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞
- –¶–µ–Ω–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞

### 2. Subscription (–ü–æ–¥–ø–∏—Å–∫–∞)
- –ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∞–≤—Ç–æ—Ä–∞
- –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –ø–ª–∞—Ç–Ω—ã–º –ø–æ—Å—Ç–∞–º –∞–≤—Ç–æ—Ä–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ

### 3. Followers-only (–¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤)
- –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∞–≤—Ç–æ—Ä–∞

## üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã Stripe
- **–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞**: 4242 4242 4242 4242
- **–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ**: 4000 0000 0000 0002
- **3D Secure**: 4000 0025 0000 3155

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
1. **–ü–æ–∫—É–ø–∫–∞ –ø–æ—Å—Ç–∞**:
   - –°–æ–∑–¥–∞–π—Ç–µ –ø–æ—Å—Ç —Å `access_level: "pay-per-post"`
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ü–µ–Ω—É –≤ —Ü–µ–Ω—Ç–∞—Ö
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫—É–ø–∏—Ç—å —Å —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π

2. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∞–≤—Ç–æ—Ä–∞**:
   - –ù–∞–π–¥–∏—Ç–µ –∞–≤—Ç–æ—Ä–∞ —Å –ø–ª–∞—Ç–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
   - –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç–∞–º

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤**:
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Stripe CLI –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- **Stripe Dashboard**: https://dashboard.stripe.com/test/payments
- **–õ–æ–≥–∏ backend**: `tail -f custom-backend.log`
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã `post_purchases`, `subscriptions`

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ Go**:
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: `go mod tidy`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é Go: —Ç—Ä–µ–±—É–µ—Ç—Å—è 1.19+

2. **–í–µ–±—Ö—É–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç**:
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ STRIPE_WEBHOOK_SECRET –≤ .env
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Stripe CLI –∑–∞–ø—É—â–µ–Ω –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

3. **Frontend –Ω–µ –≤–∏–¥–∏—Ç Stripe**:
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VITE_STRIPE_PUBLISHABLE_KEY
   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev-—Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è .env

## üéâ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:5173 –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –Ω–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ!

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [Stripe Docs](https://stripe.com/docs)
- [Stripe Testing](https://stripe.com/docs/testing)
- [Stripe Webhooks](https://stripe.com/docs/webhooks)
