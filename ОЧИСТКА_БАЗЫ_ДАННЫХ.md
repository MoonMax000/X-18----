# Инструкция по очистке базы данных

## ⚠️ ВАЖНО: Прочитайте перед выполнением!

Эта операция **НЕОБРАТИМА**. Все данные будут удалены безвозвратно.

## Шаг 1: Создайте резервную копию (на всякий случай)

### Через Railway Dashboard:
1. Откройте https://railway.app
2. Найдите сервис **Postgres**
3. Перейдите в вкладку **Backups**
4. Нажмите **Create Backup**

## Шаг 2: Подключитесь к базе данных

### Получите данные для подключения:
1. Откройте Railway Dashboard
2. Найдите сервис **Postgres**
3. Перейдите в вкладку **Connect**
4. Скопируйте **Postgres Connection URL**

### Подключитесь через psql:
```bash
psql "your_postgres_connection_url_here"
```

## Шаг 3: Выполните SQL команды для очистки

### Вариант 1: Полная очистка (удалить ВСЁ)

⚠️ Это удалит ВСЕ данные включая ВСЕХ пользователей!

```sql
-- Удаляем все связанные данные
TRUNCATE TABLE notifications CASCADE;
TRUNCATE TABLE post_reports CASCADE;
TRUNCATE TABLE likes CASCADE;
TRUNCATE TABLE bookmarks CASCADE;
TRUNCATE TABLE pinned_posts CASCADE;
TRUNCATE TABLE follows CASCADE;
TRUNCATE TABLE user_blocks CASCADE;
TRUNCATE TABLE media CASCADE;
TRUNCATE TABLE code_blocks CASCADE;
TRUNCATE TABLE posts CASCADE;
TRUNCATE TABLE users CASCADE;
TRUNCATE TABLE news_items CASCADE;
TRUNCATE TABLE sessions CASCADE;

-- Сброс последовательностей (auto-increment)
ALTER SEQUENCE IF EXISTS users_id_seq RESTART WITH 1;
ALTER SEQUENCE IF EXISTS posts_id_seq RESTART WITH 1;
ALTER SEQUENCE IF EXISTS media_id_seq RESTART WITH 1;
```

### Вариант 2: Частичная очистка (сохранить вашего админа)

Замените `admin@example.com` на ваш реальный email администратора!

```sql
-- Сохраняем ID администратора
DO $$ 
DECLARE 
    admin_id UUID;
BEGIN
    -- Получаем ID администратора (замените email!)
    SELECT id INTO admin_id FROM users WHERE email = 'admin@example.com';
    
    IF admin_id IS NULL THEN
        RAISE EXCEPTION 'Администратор не найден! Проверьте email.';
    END IF;
    
    -- Удаляем уведомления
    DELETE FROM notifications;
    
    -- Удаляем жалобы
    DELETE FROM post_reports;
    
    -- Удаляем лайки
    DELETE FROM likes;
    
    -- Удаляем закладки
    DELETE FROM bookmarks;
    
    -- Удаляем закрепленные посты
    DELETE FROM pinned_posts;
    
    -- Удаляем подписки
    DELETE FROM follows;
    
    -- Удаляем блокировки
    DELETE FROM user_blocks;
    
    -- Удаляем код-блоки
    DELETE FROM code_blocks;
    
    -- Удаляем медиа
    DELETE FROM media;
    
    -- Удаляем все посты
    DELETE FROM posts;
    
    -- Удаляем всех пользователей кроме администратора
    DELETE FROM users WHERE id != admin_id;
    
    -- Удаляем новости
    DELETE FROM news_items;
    
    -- Удаляем старые сессии
    DELETE FROM sessions WHERE user_id != admin_id;
    
    RAISE NOTICE 'Очистка завершена! Сохранен администратор с ID: %', admin_id;
END $$;
```

### Вариант 3: Удалить только посты (сохранить пользователей)

```sql
-- Удаляем все связанные с постами данные
DELETE FROM notifications WHERE post_id IS NOT NULL;
DELETE FROM post_reports;
DELETE FROM likes;
DELETE FROM bookmarks;
DELETE FROM pinned_posts;
DELETE FROM code_blocks;
DELETE FROM media;
DELETE FROM posts;

-- Сбрасываем счетчики постов у пользователей
UPDATE users SET posts_count = 0;
```

### Вариант 4: Удалить конкретного пользователя и его посты

Замените `user@example.com` на email пользователя!

```sql
DO $$ 
DECLARE 
    target_user_id UUID;
BEGIN
    -- Получаем ID пользователя
    SELECT id INTO target_user_id FROM users WHERE email = 'user@example.com';
    
    IF target_user_id IS NULL THEN
        RAISE EXCEPTION 'Пользователь не найден!';
    END IF;
    
    -- Удаляем все связанные данные
    DELETE FROM notifications WHERE actor_id = target_user_id OR target_user_id = target_user_id;
    DELETE FROM post_reports WHERE reporter_id = target_user_id;
    DELETE FROM likes WHERE user_id = target_user_id;
    DELETE FROM bookmarks WHERE user_id = target_user_id;
    DELETE FROM pinned_posts WHERE user_id = target_user_id;
    DELETE FROM follows WHERE follower_id = target_user_id OR following_id = target_user_id;
    DELETE FROM user_blocks WHERE blocker_id = target_user_id OR blocked_id = target_user_id;
    
    -- Удаляем посты пользователя
    DELETE FROM code_blocks WHERE post_id IN (SELECT id FROM posts WHERE user_id = target_user_id);
    DELETE FROM media WHERE post_id IN (SELECT id FROM posts WHERE user_id = target_user_id);
    DELETE FROM posts WHERE user_id = target_user_id;
    
    -- Удаляем пользователя
    DELETE FROM users WHERE id = target_user_id;
    
    RAISE NOTICE 'Пользователь удален!';
END $$;
```

## Шаг 4: Проверьте результат

```sql
-- Проверяем сколько осталось записей
SELECT 'users' as table_name, COUNT(*) as count FROM users
UNION ALL
SELECT 'posts', COUNT(*) FROM posts
UNION ALL
SELECT 'media', COUNT(*) FROM media
UNION ALL
SELECT 'likes', COUNT(*) FROM likes
UNION ALL
SELECT 'notifications', COUNT(*) FROM notifications;
```

## Шаг 5: Очистите медиа файлы (опционально)

⚠️ После удаления постов медиа файлы остаются на диске!

### Если используется Railway Volume:
1. Railway Dashboard → custom-backend → Settings
2. Scroll до раздела **Volumes**
3. Найдите volume с медиа файлами
4. Можно удалить весь volume и пересоздать его

### Или подключитесь к контейнеру:
```bash
# Через Railway CLI (если установлен)
railway run bash

# Удалите все медиа файлы
rm -rf /app/storage/media/*
```

## Частые сценарии использования

### Сценарий 1: "Начать с чистого листа"
Используйте **Вариант 1** - полная очистка
Затем создайте нового администратора через регистрацию

### Сценарий 2: "Удалить тестовые данные, оставить админа"
Используйте **Вариант 2** - частичная очистка
Обязательно замените email администратора!

### Сценарий 3: "Удалить только посты"
Используйте **Вариант 3** - удаление постов
Пользователи останутся, но без контента

### Сценарий 4: "Забанить проблемного пользователя"
Используйте **Вариант 4** - удаление конкретного пользователя

## Если что-то пошло не так

### Восстановление из резервной копии:
1. Railway Dashboard → Postgres → Backups
2. Найдите последний бэкап
3. Нажмите **Restore**

### Пересоздать базу данных с нуля:
```bash
# Через Railway CLI
railway down postgres
railway up postgres

# Затем запустите миграции
cd custom-backend
go run cmd/migrate/main.go
```

## Быстрый скрипт для копирования

Создайте новый файл для нужного варианта:

```bash
# cleanup-full.sql
cat > cleanup-full.sql << 'EOF'
TRUNCATE TABLE notifications CASCADE;
TRUNCATE TABLE post_reports CASCADE;
TRUNCATE TABLE likes CASCADE;
TRUNCATE TABLE bookmarks CASCADE;
TRUNCATE TABLE pinned_posts CASCADE;
TRUNCATE TABLE follows CASCADE;
TRUNCATE TABLE user_blocks CASCADE;
TRUNCATE TABLE media CASCADE;
TRUNCATE TABLE code_blocks CASCADE;
TRUNCATE TABLE posts CASCADE;
TRUNCATE TABLE users CASCADE;
TRUNCATE TABLE news_items CASCADE;
TRUNCATE TABLE sessions CASCADE;
EOF

# Выполнить
psql "your_connection_url" < cleanup-full.sql
```

## Рекомендации

1. **Всегда** делайте резервную копию перед очисткой
2. Начните с **Варианта 2** (частичная очистка) - это самый безопасный вариант
3. После очистки перезапустите backend на Railway для сброса кэша
4. Проверьте что BASE_URL установлен правильно перед созданием новых постов

## Автоматическая очистка старых данных

Можно добавить в cron задачу для регулярной очистки:

```sql
-- Удалить посты старше 30 дней
DELETE FROM posts WHERE created_at < NOW() - INTERVAL '30 days';

-- Удалить неактивные сессии старше 7 дней
DELETE FROM sessions WHERE updated_at < NOW() - INTERVAL '7 days';

-- Удалить прочитанные уведомления старше 14 дней
DELETE FROM notifications WHERE read = true AND created_at < NOW() - INTERVAL '14 days';
