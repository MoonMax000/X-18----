# –ü–ª–∞–Ω –û—Å—Ç–∞–≤—à–∏—Ö—Å—è –ó–∞–¥–∞—á

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### TOTP 2FA System (100%)
- [x] Backend encryption utils (AES-256-GCM)
- [x] Backend TOTP utils (QR codes, validation, backup codes)
- [x] Security service (generate, enable, disable, verify)
- [x] Account service (deactivate, restore, cleanup)
- [x] Cleanup service (cron jobs)
- [x] API handlers (9 endpoints)
- [x] Database migration 009
- [x] Frontend hooks (useTOTP, useAccountManagement)
- [x] UI components (ProfileSecuritySettings —Å –º–æ–¥–∞–ª–∞–º–∏)
- [x] –õ–æ–∫–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ ‚úì

---

## üöÄ Production Deployment (–ö—Ä–∏—Ç–∏—á–Ω–æ!)

### 1. Railway Database Migration
**–°—Ç–∞—Ç—É—Å:** ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í–´–°–û–ö–ò–ô

**–®–∞–≥–∏:**
```bash
# 1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Railway PostgreSQL
railway connect

# 2. –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
\i custom-backend/internal/database/migrations/009_add_totp_and_deactivation_fields.sql

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
\d users
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Railway Dashboard ‚Üí Database ‚Üí Query
- –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ 009_add_totp_and_deactivation_fields.sql
- –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL query

### 2. Railway Environment Variables
**–°—Ç–∞—Ç—É—Å:** ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í–´–°–û–ö–ò–ô

**–î–æ–±–∞–≤–∏—Ç—å:**
```
ENCRYPTION_KEY=68363127f0dc5634b09b830815a6b56ba2bbe8e02ee326461d99727ee4e02fb
```

**–ì–¥–µ:**
- Railway Dashboard ‚Üí custom-backend service
- Settings ‚Üí Variables
- Add Variable ‚Üí Name: ENCRYPTION_KEY, Value: (–∫–ª—é—á –≤—ã—à–µ)

### 3. Backend Redeploy
**–°—Ç–∞—Ç—É—Å:** ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í–´–°–û–ö–ò–ô

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ENCRYPTION_KEY:
- Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–¥–µ–ø–ª–æ–∏—Ç backend
- –ò–õ–ò –≤—Ä—É—á–Ω—É—é: Deploy ‚Üí Trigger Deploy

---

## üìù –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (–ß–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

### TOTP 2FA ‚úÖ (100% –≥–æ—Ç–æ–≤–æ)
- [x] QR –∫–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è authenticator apps
- [x] 6-–∑–Ω–∞—á–Ω—ã–µ –∫–æ–¥—ã
- [x] Backup codes (8 —à—Ç—É–∫)
- [x] AES-256-GCM encryption
- [x] UI —Å –º–æ–¥–∞–ª–∞–º–∏

### Account Deactivation ‚úÖ (100% –≥–æ—Ç–æ–≤–æ)
- [x] 30-–¥–Ω–µ–≤–Ω—ã–π recovery –ø–µ—Ä–∏–æ–¥
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ cron
- [x] Restore —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### Account Settings (–ß–∞—Å—Ç–∏—á–Ω–æ)
- [x] TOTP 2FA –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] **–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ TOTP –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è email/phone/password** ‚ö†Ô∏è
- [ ] **–£–ø—Ä–æ—â–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è (Full Name + Username)** ‚ö†Ô∏è

### Profile Fields
- [ ] **–£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–æ "Full Name" + "Username"** ‚ö†Ô∏è
- [ ] **–£–±—Ä–∞—Ç—å Save/Reset –∫–Ω–æ–ø–∫–∏** ‚ö†Ô∏è
- [ ] **Auto-save on blur** ‚ö†Ô∏è
- [ ] **–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å "Saving..." ‚Üí "Saved ‚úì"** ‚ö†Ô∏è

---

## üìã –î–µ—Ç–∞–ª—å–Ω—ã–π –ü–ª–∞–Ω –û—Å—Ç–∞–≤—à–∏—Ö—Å—è –ó–∞–¥–∞—á

### –ó–∞–¥–∞—á–∞ 1: TOTP Required for Sensitive Operations
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô  
**–í—Ä–µ–º—è:** ~2 —á–∞—Å–∞

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
1. **Backend Middleware:**
   - –°–æ–∑–¥–∞—Ç—å `custom-backend/pkg/middleware/totp_required.go`
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ TOTP header –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
   - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å 403 –µ—Å–ª–∏ TOTP –Ω–µ –≤–∫–ª—é—á–µ–Ω –∏–ª–∏ –∫–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π

2. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º:**
   ```go
   // Password change
   POST /api/auth/password/change
   
   // Email change
   POST /api/user/email/change
   
   // Phone change
   POST /api/user/phone/change
   ```

3. **Frontend:**
   - –î–æ–±–∞–≤–∏—Ç—å TOTP verification modal
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–µ—Ä–µ–¥ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
   - –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å TOTP –∫–æ–¥ –≤ header: `X-TOTP-Code`

### –ó–∞–¥–∞—á–∞ 2: Simplify Profile Fields
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô  
**–í—Ä–µ–º—è:** ~3 —á–∞—Å–∞

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**

1. **Backend - User Model:**
   ```go
   // –£–∂–µ –µ—Å—Ç—å –≤ models.User:
   Username string
   DisplayName string // —ç—Ç–æ Full Name
   
   // –£–±—Ä–∞—Ç—å –∏–∑ UI (–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –≤ –ë–î):
   Bio, Website, Location, etc.
   ```

2. **Frontend Components:**
   - `client/components/socialProfile/ProfileDetails.tsx`
   - `client/pages/ProfilePage.tsx`
   
   **–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
   ```tsx
   // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ:
   - Full Name (display_name)
   - Username (@username)
   
   // –°–∫—Ä—ã—Ç—å:
   - Bio
   - Website
   - Location
   - Birthday
   - etc.
   ```

3. **Database:**
   - –ù–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ (–ø–æ–ª—è –æ—Å—Ç–∞—é—Ç—Å—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

### –ó–∞–¥–∞—á–∞ 3: Auto-save Profile Fields
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô  
**–í—Ä–µ–º—è:** ~2 —á–∞—Å–∞

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**

1. **–°–æ–∑–¥–∞—Ç—å hook:**
   ```typescript
   // client/hooks/useAutoSave.ts
   export function useAutoSave() {
     const [saving, setSaving] = useState(false);
     const [saved, setSaved] = useState(false);
     
     const autoSave = async (field, value) => {
       setSaving(true);
       await api.updateProfile({ [field]: value });
       setSaving(false);
       setSaved(true);
       setTimeout(() => setSaved(false), 2000);
     };
     
     return { saving, saved, autoSave };
   }
   ```

2. **–û–±–Ω–æ–≤–∏—Ç—å ProfileDetails:**
   ```tsx
   <Input
     value={fullName}
     onChange={(e) => setFullName(e.target.value)}
     onBlur={() => autoSave('display_name', fullName)}
   />
   
   {saving && <span>Saving...</span>}
   {saved && <span>Saved ‚úì</span>}
   ```

3. **–£–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫–∏:**
   - –£–¥–∞–ª–∏—Ç—å Save button
   - –£–¥–∞–ª–∏—Ç—å Reset button

### –ó–∞–¥–∞—á–∞ 4: End-to-End Testing
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–ò–ó–ö–ò–ô  
**–í—Ä–µ–º—è:** ~2 —á–∞—Å–∞

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**

1. **TOTP 2FA Flow:**
   - [ ] Enable 2FA
   - [ ] Scan QR code
   - [ ] Verify code
   - [ ] Save backup codes
   - [ ] Login with TOTP
   - [ ] Use backup code
   - [ ] Regenerate backup codes
   - [ ] Disable 2FA

2. **Account Deactivation:**
   - [ ] Deactivate account
   - [ ] Verify 30-day warning
   - [ ] Restore account
   - [ ] Wait 30+ days (test auto-deletion)

3. **Profile Auto-save:**
   - [ ] Edit Full Name ‚Üí blur ‚Üí check save indicator
   - [ ] Edit Username ‚Üí blur ‚Üí check save indicator
   - [ ] Verify changes persist

---

## üéØ Recommended Order

### Week 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ)
1. ‚úÖ ~~Apply local migration~~ (DONE)
2. üî¥ Apply Railway migration
3. üî¥ Add ENCRYPTION_KEY to Railway
4. üî¥ Redeploy backend
5. üî¥ Test TOTP 2FA on production

### Week 2 (–í–∞–∂–Ω–æ)
6. üü° TOTP Required for sensitive operations
7. üü° Simplify profile fields
8. üü° Auto-save profile fields

### Week 3 (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
9. üü¢ End-to-end testing
10. üü¢ Documentation updates
11. üü¢ User guide

---

## üìä Progress Tracker

### –û–±—â–∏–π –ü—Ä–æ–≥—Ä–µ—Å—Å: 70% ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë

- TOTP 2FA Backend: 100% ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
- TOTP 2FA Frontend: 100% ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
- Account Management: 100% ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
- Production Deployment: 0% ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
- TOTP for Sensitive Ops: 0% ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
- Profile Simplification: 0% ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
- Auto-save: 0% ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë

---

## üîß Quick Commands

### Local Development
```bash
# Apply migration locally
./apply-migration-009-local.sh

# Start backend
./START_CUSTOM_BACKEND_STACK.sh

# Start frontend
npm run dev
```

### Railway Production
```bash
# Connect to database
railway connect

# View logs
railway logs -f

# Redeploy
railway up
```

---

## üìû Troubleshooting

### Issue: Migration fails
**Solution:** Check if columns already exist
```sql
\d users -- view table structure
```

### Issue: TOTP not working
**Solution:** 
1. Check ENCRYPTION_KEY is set
2. Verify time sync on server
3. Check Redis is running

### Issue: Auto-save –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**Solution:**
1. Check network tab for API calls
2. Verify onBlur events firing
3. Check debounce timing

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 29.10.2025  
**–ê–≤—Ç–æ—Ä:** Cline AI Assistant  
**–í–µ—Ä—Å–∏—è:** 1.0
