# ĞÑ‚Ñ‡ĞµÑ‚ Ğ¾ Ğ²Ğ½ĞµĞ´Ñ€ĞµĞ½Ğ¸Ğ¸ TOTP-Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹

## Ğ”Ğ°Ñ‚Ğ°: 29.10.2025
## Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: âœ… Backend Ğ³Ğ¾Ñ‚Ğ¾Ğ²

---

## ğŸ¯ Ğ§Ñ‚Ğ¾ ÑĞ´ĞµĞ»Ğ°Ğ½Ğ¾

### 1. âœ… Middleware Ğ´Ğ»Ñ TOTP Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸

Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ñ„Ğ°Ğ¹Ğ» `custom-backend/pkg/middleware/totp_required.go`:

- **TOTPRequired** - Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ TOTP ĞºĞ¾Ğ´ Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñƒ
  - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº `X-TOTP-Code`
  - Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¹ TOTP ĞºĞ¾Ğ´
  - Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ `403` Ñ Ñ„Ğ»Ğ°Ğ³Ğ¾Ğ¼ `requires_totp: true` ĞµÑĞ»Ğ¸ ĞºĞ¾Ğ´ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚/Ğ½ĞµĞ²ĞµÑ€ĞµĞ½

- **TOTPOptional** - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ TOTP Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½ Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  - Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ `totp_enabled` Ğ¸ `totp_verified` Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ
  - ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞµÑĞ»Ğ¸ TOTP Ğ½Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½

### 2. âœ… SecurityService Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½

Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ² `custom-backend/internal/services/security.go`:

```go
// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ²ĞºĞ»ÑÑ‡ĞµĞ½ Ğ»Ğ¸ TOTP Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
func (s *SecurityService) GetUserTOTPStatus(userID uint) (bool, error)

// Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµÑ‚ TOTP ĞºĞ¾Ğ´ (6 Ñ†Ğ¸Ñ„Ñ€)
func (s *SecurityService) VerifyTOTPCode(userID uint, code string) (bool, error)
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ:** ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° backup ĞºĞ¾Ğ´Ğ¾Ğ² Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸.

### 3. âœ… Protected Operations Handler

Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ñ„Ğ°Ğ¹Ğ» `custom-backend/internal/api/protected_operations.go` Ñ Ñ‚Ñ€ĞµĞ¼Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸:

#### a) Ğ¡Ğ¼ĞµĞ½Ğ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
**POST** `/api/auth/password/change`
- Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ TOTP ĞºĞ¾Ğ´ ĞµÑĞ»Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑĞ¸Ğ»Ñƒ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
- ĞÑ‚Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ²ÑĞµ ÑĞµÑÑĞ¸Ğ¸ ĞºÑ€Ğ¾Ğ¼Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹

#### b) Ğ¡Ğ¼ĞµĞ½Ğ° email
**POST** `/api/users/email/change`
- Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ TOTP ĞºĞ¾Ğ´ ĞµÑĞ»Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ email
- Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ´ Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ email
- ĞŸĞ¾Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ email ĞºĞ°Ğº Ğ½ĞµĞ²ĞµÑ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹

#### c) Ğ¡Ğ¼ĞµĞ½Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
**POST** `/api/users/phone/change`
- Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ TOTP ĞºĞ¾Ğ´ ĞµÑĞ»Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° (Ğ½Ğ¾Ğ²Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ `ValidatePhone`)
- Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ´ Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ°
- ĞŸĞ¾Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ ĞºĞ°Ğº Ğ½ĞµĞ²ĞµÑ€Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹

### 4. âœ… Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°

Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ² `custom-backend/pkg/utils/validation.go`:

```go
func ValidatePhone(phone string) (bool, string)
```

ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚:
- ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 10 Ñ†Ğ¸Ñ„Ñ€
- ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 20 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
- ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹: `+1234567890`, `(123) 456-7890`, `123-456-7890`

### 5. âœ… ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹

Ğ’ `custom-backend/cmd/server/main.go` Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹:

```go
// Ğ¡Ğ¼ĞµĞ½Ğ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
auth.Post("/password/change",
    middleware.JWTMiddleware(cfg),
    middleware.TOTPRequired(securityService),
    protectedOpsHandler.ChangePassword)

// Ğ¡Ğ¼ĞµĞ½Ğ° email
users.Post("/email/change",
    middleware.JWTMiddleware(cfg),
    middleware.TOTPRequired(securityService),
    protectedOpsHandler.ChangeEmail)

// Ğ¡Ğ¼ĞµĞ½Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
users.Post("/phone/change",
    middleware.JWTMiddleware(cfg),
    middleware.TOTPRequired(securityService),
    protectedOpsHandler.ChangePhone)
```

### 6. âœ… ĞšĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ°

Backend ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº.

---

## ğŸ“‹ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸

### Backend (Production)

1. **ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ 009 Ğ½Ğ° Railway**
   ```bash
   # ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Railway
   psql $DATABASE_URL
   
   # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ
   \i custom-backend/internal/database/migrations/009_add_totp_and_deactivation_fields.sql
   ```

2. **Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ENCRYPTION_KEY Ğ² Railway**
   ```bash
   railway variables --set ENCRYPTION_KEY="your-32-character-secret-key-here"
   ```
   
   Ğ˜Ğ»Ğ¸ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ»ÑÑ‡:
   ```bash
   openssl rand -base64 32
   ```

3. **Ğ—Ğ°Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ÑŒ backend Ğ½Ğ° Railway**
   ```bash
   git add .
   git commit -m "Add TOTP-protected operations"
   git push origin main
   ```

### Frontend

#### 1. ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ TOTP Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸

Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ° TOTP ĞºĞ¾Ğ´Ğ°:

```typescript
// client/components/auth/TOTPVerificationModal.tsx

interface TOTPVerificationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onVerify: (code: string) => Promise<void>;
  operation: string; // "change password", "change email", etc.
}
```

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»:**
- Ğ˜Ğ½Ğ¿ÑƒÑ‚ Ğ´Ğ»Ñ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°
- ĞĞ²Ñ‚Ğ¾Ñ„Ğ¾ĞºÑƒÑ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸
- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹, 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)
- ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Verify" Ñ loading state
- ĞŸĞ¾ĞºĞ°Ğ· Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
- Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° "ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ authenticator app"

#### 2. Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ² ProfileSecuritySettings

ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `client/components/socialProfile/ProfileSecuritySettings.tsx`:

```typescript
// ĞŸĞµÑ€ĞµĞ´ ÑĞ¼ĞµĞ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ/email/phone
if (user.totp_enabled) {
  // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ TOTPVerificationModal
  const code = await showTOTPModal();
  
  // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼ Ğ² Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞµ
  await fetch('/api/auth/password/change', {
    method: 'POST',
    headers: {
      'X-TOTP-Code': code,
      // ...
    },
    body: JSON.stringify({ /* ... */ })
  });
}
```

#### 3. Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ĞµĞ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ

Ğ’ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾:
- **Full Name** (Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ÑŒ First Name + Last Name)
- **Username**

Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ First Name Ğ¸ Last Name.

#### 4. Auto-save Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»

Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ debounced auto-save Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ĞµĞ¹:

```typescript
useEffect(() => {
  const timer = setTimeout(() => {
    // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ "Saving..."
    setSavingStatus('saving');
    
    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
    await updateProfile(data);
    
    // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ "Saved âœ“"
    setSavingStatus('saved');
    
    // Ğ¡ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· 2 ÑĞµĞºÑƒĞ½Ğ´Ñ‹
    setTimeout(() => setSavingStatus(null), 2000);
  }, 1000); // debounce 1 ÑĞµĞºÑƒĞ½Ğ´Ğ°
  
  return () => clearTimeout(timer);
}, [fullName, username]);
```

---

## ğŸ”’ ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°

### 1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ±ĞµĞ· TOTP

```
POST /api/auth/password/change
Authorization: Bearer jwt_token
Body: { current_password, new_password }

Response: 200 OK âœ…
```

### 2. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ TOTP - Ğ±ĞµĞ· ĞºĞ¾Ğ´Ğ°

```
POST /api/auth/password/change
Authorization: Bearer jwt_token
Body: { current_password, new_password }

Response: 403 Forbidden
{
  "error": "TOTP code required",
  "requires_totp": true,
  "totp_code_missing": true
}
```

### 3. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ TOTP - Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼

```
POST /api/auth/password/change
Authorization: Bearer jwt_token
X-TOTP-Code: 123456
Body: { current_password, new_password }

Response: 200 OK âœ…
```

---

## ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

1. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ backend:
   ```bash
   ./START_CUSTOM_BACKEND_STACK.sh
   ```

2. Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ TOTP Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:
   ```bash
   curl -X POST http://localhost:8080/api/totp/generate \
     -H "Authorization: Bearer $TOKEN"
   ```

3. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ±ĞµĞ· ĞºĞ¾Ğ´Ğ°:
   ```bash
   curl -X POST http://localhost:8080/api/auth/password/change \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"current_password":"old","new_password":"new123456"}'
   
   # Ğ”Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ 403 Ñ requires_totp: true
   ```

4. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ TOTP ĞºĞ¾Ğ´Ğ¾Ğ¼:
   ```bash
   curl -X POST http://localhost:8080/api/auth/password/change \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -H "X-TOTP-Code: 123456" \
     -d '{"current_password":"old","new_password":"new123456"}'
   
   # Ğ”Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ 200 OK
   ```

---

## ğŸ“Š ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend (React)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. User initiates sensitive operation         â”‚   â”‚
â”‚  â”‚     (change password/email/phone)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                 â”‚
â”‚                       â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. Check if user has TOTP enabled             â”‚   â”‚
â”‚  â”‚     (from user profile state)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                 â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚          â–¼                          â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  TOTP OFF    â”‚         â”‚  TOTP ON         â”‚        â”‚
â”‚  â”‚  Send direct â”‚         â”‚  Show TOTP modal â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚          â”‚                          â”‚                   â”‚
â”‚          â”‚                          â–¼                   â”‚
â”‚          â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚          â”‚                â”‚  Get 6-digit codeâ”‚        â”‚
â”‚          â”‚                â”‚  from user       â”‚        â”‚
â”‚          â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚          â”‚                          â”‚                   â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                      â–¼                                   â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚          â”‚  Send HTTP request with â”‚                   â”‚
â”‚          â”‚  X-TOTP-Code header     â”‚                   â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend (Go/Fiber)                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  JWT Middleware                                 â”‚   â”‚
â”‚  â”‚  â€¢ Validates JWT token                          â”‚   â”‚
â”‚  â”‚  â€¢ Sets user_id in context                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                 â”‚
â”‚                       â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  TOTP Required Middleware                       â”‚   â”‚
â”‚  â”‚  â€¢ Checks if user has TOTP enabled              â”‚   â”‚
â”‚  â”‚  â€¢ If enabled, validates X-TOTP-Code header     â”‚   â”‚
â”‚  â”‚  â€¢ Calls SecurityService.VerifyTOTPCode()       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                 â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚          â–¼                          â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Invalid codeâ”‚         â”‚  Valid code      â”‚        â”‚
â”‚  â”‚  Return 403  â”‚         â”‚  Continue to     â”‚        â”‚
â”‚  â”‚  requires_totp         â”‚  handler         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚                   â”‚
â”‚                                     â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Protected Operation Handler                    â”‚   â”‚
â”‚  â”‚  â€¢ Validates current password                   â”‚   â”‚
â”‚  â”‚  â€¢ Updates password/email/phone                 â”‚   â”‚
â”‚  â”‚  â€¢ Generates verification codes if needed       â”‚   â”‚
â”‚  â”‚  â€¢ Returns success response                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Checklist Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ

**Backend:**
- [x] Middleware TOTPRequired ÑĞ¾Ğ·Ğ´Ğ°Ğ½
- [x] SecurityService.VerifyTOTPCode Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½
- [x] ProtectedOperationsHandler ÑĞ¾Ğ·Ğ´Ğ°Ğ½
- [x] Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ°
- [x] ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹
- [x] ĞšĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ°
- [ ] ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ 009 Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ° Ğ½Ğ° Railway
- [ ] ENCRYPTION_KEY Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Railway
- [ ] Backend Ğ·Ğ°Ğ´ĞµĞ¿Ğ»Ğ¾ĞµĞ½ Ğ½Ğ° Railway

**Frontend:**
- [ ] TOTPVerificationModal ÑĞ¾Ğ·Ğ´Ğ°Ğ½
- [ ] Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² ProfileSecuritySettings
- [ ] ĞŸĞ¾Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ ÑƒĞ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ñ‹ (Full Name + Username)
- [ ] Auto-save Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
- [ ] Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ¾

---

## ğŸ“ ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ñ

1. **Backup ĞºĞ¾Ğ´Ñ‹** - Ğ±ÑƒĞ´ÑƒÑ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ² ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸
2. **Rate limiting** - ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· AuthRateLimiter
3. **Session revocation** - Ğ¿Ñ€Ğ¸ ÑĞ¼ĞµĞ½Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ²ÑĞµ ÑĞµÑÑĞ¸Ğ¸ ĞºÑ€Ğ¾Ğ¼Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ
4. **Email/Phone verification** - Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¼ĞµĞ½Ñ‹ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ½Ğ¾Ğ²Ñ‹Ğµ ĞºĞ¾Ğ´Ñ‹ Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸

---

## ğŸ¯ Ğ˜Ñ‚Ğ¾Ğ³

Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ backend-Ñ‡Ğ°ÑÑ‚ÑŒ TOTP-Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹:
- âœ… Ğ¡Ğ¼ĞµĞ½Ğ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ TOTP
- âœ… Ğ¡Ğ¼ĞµĞ½Ğ° email Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ TOTP
- âœ… Ğ¡Ğ¼ĞµĞ½Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ TOTP

ĞÑÑ‚Ğ°ĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾:
1. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° Production
2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ENCRYPTION_KEY
3. Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ frontend UI

**Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ğ´ĞµĞ¿Ğ»Ğ¾Ñ!** ğŸš€
