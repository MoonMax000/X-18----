# Применение миграции 009 к Railway PostgreSQL

## Проблема
Railway CLI не может автоматически применить миграцию из-за проблем с подключением к удаленной базе данных.

## Решение: Применить миграцию вручную через Railway Dashboard

### Шаг 1: Открыть Railway Dashboard
1. Перейти на https://railway.app
2. Войти в свой проект
3. Открыть PostgreSQL сервис

### Шаг 2: Открыть Query Editor
1. В PostgreSQL сервисе нажать на вкладку "Query"
2. Откроется редактор SQL запросов

### Шаг 3: Скопировать и выполнить SQL
Скопируйте следующий SQL код и вставьте в Query Editor:

```sql
-- Migration 009: Add TOTP and account deactivation fields

ALTER TABLE users ADD COLUMN IF NOT EXISTS totp_secret TEXT;
ALTER TABLE users ADD COLUMN IF NOT EXISTS totp_enabled BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS is_deactivated BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS deactivation_reason TEXT;
ALTER TABLE users ADD COLUMN IF NOT EXISTS deactivated_at TIMESTAMP;
ALTER TABLE users ADD COLUMN IF NOT EXISTS deletion_scheduled_at TIMESTAMP;

-- Create index for deactivated accounts cleanup
CREATE INDEX IF NOT EXISTS idx_users_deletion_scheduled ON users(deletion_scheduled_at) WHERE deletion_scheduled_at IS NOT NULL;

-- Create index for TOTP enabled users
CREATE INDEX IF NOT EXISTS idx_users_totp_enabled ON users(totp_enabled) WHERE totp_enabled = TRUE;
```

### Шаг 4: Выполнить запрос
1. Нажмите кнопку "Run Query" или Ctrl+Enter
2. Дождитесь успешного выполнения
3. Должно появиться сообщение "Query executed successfully"

### Шаг 5: Проверить результат
Выполните проверочный запрос:

```sql
\d users
```

Вы должны увидеть новые колонки:
- totp_secret
- totp_enabled
- is_deactivated
- deactivation_reason
- deactivated_at
- deletion_scheduled_at

## Альтернативный метод: через Railway CLI

Если Railway Dashboard не работает, используйте следующую команду:

```bash
cd custom-backend && railway connect postgres
```

После подключения вставьте SQL код из шага 3 и нажмите Enter.

## После применения миграции

1. Миграция применена ✅
2. Backend уже задеплоен с новым кодом TOTP ✅
3. Frontend будет автоматически задеплоен через Netlify ✅

Функция TOTP 2FA будет работать сразу после применения миграции!
