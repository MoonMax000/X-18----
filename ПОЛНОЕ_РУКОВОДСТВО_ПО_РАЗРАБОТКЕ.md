# Полное руководство по разработке и тестированию

## Оглавление
1. [Архитектура проекта](#архитектура-проекта)
2. [Локальная разработка](#локальная-разработка)
3. [Тестирование изменений](#тестирование-изменений)
4. [Деплой на production](#деплой-на-production)
5. [Workflow разработки](#workflow-разработки)
6. [Частые проблемы и решения](#частые-проблемы-и-решения)

---

## Архитектура проекта

### Структура приложения

```
X-18----/
├── client/              # Frontend (React + Vite)
│   ├── components/      # React компоненты
│   ├── hooks/          # Custom hooks
│   ├── services/       # API сервисы
│   └── .env.production # Production переменные окружения
│
├── custom-backend/     # Backend (Go)
│   ├── cmd/server/     # Entry point
│   ├── internal/       # Внутренняя логика
│   ├── pkg/           # Публичные пакеты
│   └── .env           # Переменные окружения
│
└── scripts/           # Утилиты для запуска
```

### Среды развертывания

1. **Local (Локальная разработка)**
   - Frontend: `http://localhost:5173` (Vite dev server)
   - Backend: `http://localhost:8080`
   - База данных: PostgreSQL локально

2. **Production**
   - Frontend: `https://sunny-froyo-f47377.netlify.app` (Netlify)
   - Backend: `https://x-18-production-38ec.up.railway.app` (Railway)
   - База данных: PostgreSQL на Railway

---

## Локальная разработка

### 1. Первоначальная настройка

#### Установите зависимости

```bash
# Frontend зависимости
cd client
npm install

# Backend зависимости (Go modules)
cd custom-backend
go mod download
```

#### Настройте переменные окружения

**Frontend (`client/.env.local`):**
```env
VITE_API_URL=http://localhost:8080
VITE_CUSTOM_BACKEND_URL=http://localhost:8080
```

**Backend (`custom-backend/.env`):**
```env
# Database
DATABASE_URL=postgresql://postgres:password@localhost:5432/x18_dev?sslmode=disable

# Server
PORT=8080
HOST=0.0.0.0

# JWT Secrets
ACCESS_TOKEN_SECRET=your-local-secret-key
REFRESH_TOKEN_SECRET=your-local-refresh-secret-key

# Redis
REDIS_URL=redis://localhost:6379

# CORS
CORS_ORIGINS=http://localhost:5173,http://localhost:5174

# Environment
GO_ENV=development
```

#### Запустите локальную базу данных

```bash
# PostgreSQL через Docker
docker run -d \
  --name x18-postgres \
  -e POSTGRES_PASSWORD=password \
  -e POSTGRES_DB=x18_dev \
  -p 5432:5432 \
  postgres:15

# Redis через Docker
docker run -d \
  --name x18-redis \
  -p 6379:6379 \
  redis:7
```

#### Выполните миграции

```bash
cd custom-backend

# Миграции выполняются автоматически при запуске сервера
# Но вы можете запустить их вручную:
go run cmd/server/main.go migrate
```

### 2. Запуск локального стека

#### Вариант 1: Используйте готовый скрипт

```bash
# Из корневой директории проекта
./START_CUSTOM_BACKEND_STACK.sh
```

Этот скрипт запустит:
- Backend на `http://localhost:8080`
- Frontend на `http://localhost:5173`

#### Вариант 2: Запускайте вручную

**Терминал 1 - Backend:**
```bash
cd custom-backend
go run cmd/server/main.go
```

**Терминал 2 - Frontend:**
```bash
cd client
npm run dev
```

### 3. Проверка работоспособности

Откройте браузер на `http://localhost:5173` и проверьте:
- ✅ Страница загружается
- ✅ Можно зарегистрироваться/войти
- ✅ API запросы работают (проверьте в Developer Tools -> Network)

---

## Тестирование изменений

### 1. Разработка новой фичи

#### Пример: Добавление нового API endpoint

**Шаг 1:** Создайте код в backend
```go
// custom-backend/internal/api/example.go
func (s *Server) handleExample(w http.ResponseWriter, r *http.Request) {
    // Ваш код
}
```

**Шаг 2:** Зарегистрируйте route
```go
// custom-backend/internal/api/routes.go
r.Get("/api/example", s.handleExample)
```

**Шаг 3:** Перезапустите backend
```bash
# Ctrl+C в терминале с backend, затем:
go run cmd/server/main.go
```

**Шаг 4:** Протестируйте endpoint
```bash
curl http://localhost:8080/api/example
```

**Шаг 5:** Создайте frontend интеграцию
```typescript
// client/services/api/custom-backend.ts
export async function getExample() {
  const response = await fetch(`${API_URL}/api/example`);
  return response.json();
}
```

**Шаг 6:** Используйте в компоненте
```tsx
// client/pages/ExamplePage.tsx
const data = await getExample();
```

### 2. Тестирование изменений в базе данных

#### Добавление новой миграции

```sql
-- custom-backend/internal/database/migrations/008_example.sql
-- +migrate Up
ALTER TABLE users ADD COLUMN new_field VARCHAR(255);

-- +migrate Down
ALTER TABLE users DROP COLUMN new_field;
```

#### Применение миграции локально
```bash
cd custom-backend
go run cmd/server/main.go migrate
```

### 3. Автоматическое тестирование

```bash
# Backend тесты
cd custom-backend
go test ./...

# Frontend тесты
cd client
npm test
```

---

## Деплой на production

### Понимание процесса деплоя

#### Текущая настройка CI/CD

**GitHub Actions автоматически деплоит:**

1. **Frontend → Netlify**
   - Триггер: Push в ветку `main`
   - Файл: `.github/workflows/deploy-netlify.yml`
   - Процесс: Build → Deploy на Netlify

2. **Backend → Railway**
   - Триггер: Push в ветку `main`
   - Файл: `.github/workflows/deploy-railway.yml`
   - Процесс: Build → Deploy на Railway

### Процесс деплоя

#### 1. Подготовка изменений

```bash
# Убедитесь, что все изменения закоммичены
git status

# Убедитесь, что локальные тесты проходят
cd custom-backend && go test ./...
cd client && npm test
```

#### 2. Коммит и пуш

```bash
git add .
git commit -m "Описание ваших изменений"
git push origin main
```

#### 3. Мониторинг деплоя

**Проверьте GitHub Actions:**
```
https://github.com/MoonMax000/X-18----/actions
```

Вы увидите два workflow:
- ✅ Deploy Frontend to Netlify
- ✅ Deploy Backend to Railway

**Если деплой упал (красный крестик):**
1. Кликните на workflow
2. Посмотрите логи ошибок
3. Исправьте проблему
4. Сделайте новый коммит

#### 4. Проверка production

```bash
# Используйте готовый скрипт
./check-deployments.sh
```

Или вручную:
```bash
# Проверка frontend
curl https://sunny-froyo-f47377.netlify.app

# Проверка backend
curl https://x-18-production-38ec.up.railway.app/health
```

---

## Workflow разработки

### Рекомендуемый процесс

```
1. Создайте ветку для фичи
   ↓
2. Разработка локально
   ↓
3. Тестирование локально
   ↓
4. Коммит изменений
   ↓
5. Создайте Pull Request
   ↓
6. Code review (опционально)
   ↓
7. Merge в main
   ↓
8. Автоматический деплой
   ↓
9. Проверка production
```

### Пример workflow

#### День 1: Новая фича

```bash
# 1. Создайте feature branch
git checkout -b feature/admin-panel-fixes

# 2. Разработка
# Редактируйте файлы...

# 3. Тестирование локально
./START_CUSTOM_BACKEND_STACK.sh
# Тестируйте в браузере на localhost:5173

# 4. Коммит
git add custom-backend/internal/api/admin.go
git commit -m "fix: исправлена проверка роли админа"

# 5. Пуш в feature branch
git push origin feature/admin-panel-fixes
```

#### День 2: Code review и merge

```bash
# 1. Создайте Pull Request на GitHub
# https://github.com/MoonMax000/X-18----/pulls

# 2. После review - merge в main
git checkout main
git pull origin main

# 3. GitHub Actions автоматически задеплоит
# Мониторьте на https://github.com/MoonMax000/X-18----/actions

# 4. Проверьте production
./check-deployments.sh
```

---

## Частые проблемы и решения

### Проблема 1: Изменения не появляются на production

**Причина:** GitHub Actions workflow упал

**Решение:**
```bash
# 1. Проверьте статус workflow
gh run list

# 2. Посмотрите логи последнего run
gh run view --log

# 3. Если нужно, перезапустите workflow
gh run rerun [run-id]
```

### Проблема 2: Локальные переменные окружения не совпадают с production

**Проблема:** Используете `localhost` вместо production URLs

**Решение:**
```bash
# Создайте .env.local для локальной разработки
# client/.env.local
VITE_API_URL=http://localhost:8080

# client/.env.production уже настроен для production
VITE_API_URL=https://x-18-production-38ec.up.railway.app
```

### Проблема 3: База данных рассинхронизирована

**Проблема:** Локальная БД отличается от production

**Решение:**
```bash
# Опция 1: Сбросьте локальную БД
docker rm -f x18-postgres
docker run -d --name x18-postgres -e POSTGRES_PASSWORD=password -p 5432:5432 postgres:15

# Опция 2: Восстановите из production backup
# (требует доступ к Railway)
```

### Проблема 4: CORS ошибки на production

**Проблема:** Frontend не может обращаться к Backend

**Решение:**
```bash
# Проверьте переменную CORS_ORIGINS на Railway
# Railway Dashboard → custom-backend → Variables → CORS_ORIGINS
# Должно быть: https://sunny-froyo-f47377.netlify.app
```

---

## Быстрый чеклист разработчика

### Перед началом работы:
- [ ] `git pull origin main` - обновите код
- [ ] `./START_CUSTOM_BACKEND_STACK.sh` - запустите локально
- [ ] Проверьте, что все работает локально

### Во время разработки:
- [ ] Пишите код небольшими итерациями
- [ ] Тестируйте каждое изменение локально
- [ ] Делайте коммиты часто с понятными сообщениями

### Перед деплоем:
- [ ] Все тесты проходят локально
- [ ] Код работает в локальной среде
- [ ] Нет console.log / debug кода
- [ ] Обновлена документация (если нужно)

### После деплоя:
- [ ] Проверьте GitHub Actions - деплой успешен
- [ ] Проверьте production сайт
- [ ] Проверьте логи на наличие ошибок

---

## Полезные команды

### Git
```bash
git status                 # Статус файлов
git log --oneline -10      # Последние 10 коммитов
git diff                   # Изменения в файлах
```

### Docker
```bash
docker ps                  # Список запущенных контейнеров
docker logs x18-postgres   # Логи PostgreSQL
docker exec -it x18-postgres psql -U postgres  # Подключение к БД
```

### Go (Backend)
```bash
go run cmd/server/main.go  # Запуск
go test ./...             # Тесты
go fmt ./...              # Форматирование
go mod tidy               # Очистка зависимостей
```

### Node (Frontend)
```bash
npm run dev              # Dev server
npm run build           # Production build
npm run preview         # Preview production build
npm test                # Тесты
```

---

## Контакты и ресурсы

- **GitHub Repository:** https://github.com/MoonMax000/X-18----
- **Frontend (Netlify):** https://sunny-froyo-f47377.netlify.app
- **Backend (Railway):** https://x-18-production-38ec.up.railway.app
- **GitHub Actions:** https://github.com/MoonMax000/X-18----/actions

---

## Следующие шаги

1. Прочитайте это руководство полностью
2. Настройте локальную среду разработки
3. Попробуйте сделать небольшое изменение и задеплоить его
4. Изучите GitHub Actions workflows
5. Практикуйтесь!

**Помните:** Лучший способ изучить workflow - это практика. Начните с малого и постепенно усложняйте задачи.
