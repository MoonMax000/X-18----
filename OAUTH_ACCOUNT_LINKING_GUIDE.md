# üîó OAuth Account Linking - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è OAuth –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (Google, Apple) —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ email.

## ‚úÖ –ß—Ç–æ –°–¥–µ–ª–∞–Ω–æ

### 1. Frontend

**–°–æ–∑–¥–∞–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:** `client/components/auth/AccountLinkingModal.tsx`
- ‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
- ‚úÖ –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–ª–∞–¥–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–º
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ö—Ä–∞—Å–∏–≤—ã–π UI —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏

**–û–±–Ω–æ–≤–ª–µ–Ω:** `client/pages/OAuthCallback.tsx`
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ `requires_account_linking=true`
- ‚úÖ –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª–∞ AccountLinkingModal
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ `/api/auth/oauth/link/confirm`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è

### 2. Backend

**–û–±–Ω–æ–≤–ª–µ–Ω:** `custom-backend/internal/api/oauth_handlers.go`
- ‚úÖ –ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ email - —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ linking
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –≤ Redis (TTL 10 –º–∏–Ω—É—Ç)
- ‚úÖ Endpoint `/api/auth/oauth/link/confirm` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

## üîÑ –ö–∞–∫ –≠—Ç–æ –†–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π OAuth –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "Sign in with Google" –∏–ª–∏ "Sign in with Apple"
2. OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç email
4. Email –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
5. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å —Ç–æ–∫–µ–Ω–æ–º

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: OAuth –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º email (Account Linking)
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "Sign in with Google" –∏–ª–∏ "Sign in with Apple"
2. OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç email
4. **Email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è linking_token**
5. **–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/auth/callback?requires_account_linking=true&email=...&provider=...&linking_token=...`**
6. **Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª AccountLinkingModal**
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
8. Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST `/api/auth/oauth/link/confirm` —Å `{linking_token, password}`
9. Backend:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç linking_token –≤ Redis
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–æ–ª—å
   - –°–≤—è–∑—ã–≤–∞–µ—Ç OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
10. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏—Ç –≤ —Å–∏—Å—Ç–µ–º—É

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

1. **–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç –ø–æ email:**
   ```
   Email: test@example.com
   Password: TestPassword123!
   ```

2. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google/Apple —Å —Ç–µ–º –∂–µ email:**
   - Google: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ test@example.com
   - Apple: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ email

### –û–∂–∏–¥–∞–µ–º—ã–π –†–µ–∑—É–ª—å—Ç–∞—Ç

1. **–ü–æ—è–≤–ª—è–µ—Ç—Å—è –º–æ–¥–∞–ª:**
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–°–≤—è–∑—ã–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞"
   - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: "–ê–∫–∫–∞—É–Ω—Ç —Å email test@example.com —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
   - –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è

2. **–í–≤–æ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:**
   - –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚Üí —É—Å–ø–µ—Ö, –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚Üí –æ—à–∏–±–∫–∞ "Invalid password"

3. **–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
   - –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤—Ö–æ–¥–∏—Ç—å –∫–∞–∫ —á–µ—Ä–µ–∑ email+–ø–∞—Ä–æ–ª—å, —Ç–∞–∫ –∏ —á–µ—Ä–µ–∑ OAuth

### –õ–æ–∫–∞–ª—å–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
./monitor-oauth-local-enhanced.sh --follow

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ backend
cd custom-backend
./START_CUSTOM_BACKEND_STACK.sh

# –í —Ç—Ä–µ—Ç—å–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å—Ç–∏—Ç–µ frontend
cd client
npm run dev

# –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä
open http://localhost:5173
```

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
./monitor-oauth-production-enhanced.sh --follow

# –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä
open https://social.tyriantrade.com
```

## üîç –ß—Ç–æ –°–º–æ—Ç—Ä–µ—Ç—å –≤ –õ–æ–≥–∞—Ö

### Backend Logs

**–£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ linking request:**
```
Email already exists for user: <user_id>
Redirecting to frontend for account linking: ...
```

**–£—Å–ø–µ—à–Ω–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ:**
```
Accounts linked successfully
OAuth provider linked successfully
```

**–û—à–∏–±–∫–∏:**
```
ERROR: Invalid password
ERROR: Invalid or expired linking token
```

### Frontend Logs (Console)

**Account linking required:**
```
üîó Account linking required for: test@example.com
```

**–£—Å–ø–µ—à–Ω–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ:**
```
‚úÖ Accounts linked successfully
‚úÖ User data fetched: <username>
üöÄ Redirecting to home...
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Linking Token
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º (32 –±–∞–π—Ç–∞, base64)
- ‚úÖ –•—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis —Å TTL 10 –º–∏–Ω—É—Ç
- ‚úÖ –£–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –°–≤—è–∑–∞–Ω —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º email –∏ provider

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ü–∞—Ä–æ–ª—è
- ‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–ª–∞–¥–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–º
- ‚úÖ Bcrypt —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç brute-force (—á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã security)

### –î–∞–Ω–Ω—ã–µ –≤ Cache
–§–æ—Ä–º–∞—Ç: `provider|provider_id|email|name|avatar_url|email_verified|user_id`
- –•—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏ Redis
- –£–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ 10 –º–∏–Ω—É—Ç –∏–ª–∏ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üìù API Endpoints

### POST /api/auth/oauth/link/confirm
–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è OAuth –∞–∫–∫–∞—É–Ω—Ç–∞

**Request:**
```json
{
  "linking_token": "abc123...",
  "password": "TestPassword123!"
}
```

**Response (Success):**
```json
{
  "message": "OAuth provider linked successfully",
  "user": { ... },
  "access_token": "jwt_token",
  "token_type": "Bearer",
  "expires_in": 900,
  "session_id": "session_uuid"
}
```

**Response (Error):**
```json
{
  "error": "Invalid password"
}
```
```json
{
  "error": "Invalid or expired linking token"
}
```

## üöÄ –î–µ–ø–ª–æ–π

### –õ–æ–∫–∞–ª—å–Ω–æ
–ò–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –≤ –∫–æ–¥–µ, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ backend –∏ frontend.

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω
```bash
# Commit –∏ push –∏–∑–º–µ–Ω–µ–Ω–∏–π
git add .
git commit -m "feat: Add OAuth account linking modal"
git push origin main

# GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç
# –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º:
gh run watch
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ –®–∞–≥–∏

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ:**
   ```bash
   ./monitor-oauth-local-enhanced.sh --follow
   ```

2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:**
   ```bash
   ./monitor-oauth-production-enhanced.sh --follow
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Apple OAuth:**
   - –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è account linking
   - –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–±–ª–µ–º—É "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- Linking token –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω —Ç–æ–ª—å–∫–æ 10 –º–∏–Ω—É—Ç
- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å (OAuth-only –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã —Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å)
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å email –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ (Google, Apple)

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –î–æ–∫—É–º–µ–Ω—Ç—ã

- [OAUTH_MONITORING_COMPLETE.md](./OAUTH_MONITORING_COMPLETE.md) - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ OAuth
- [OAUTH_DEPLOYMENT_GUIDE.md](./OAUTH_DEPLOYMENT_GUIDE.md) - –î–µ–ø–ª–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [APPLE_OAUTH_PRODUCTION_SETUP.md](./APPLE_OAUTH_PRODUCTION_SETUP.md) - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Apple OAuth

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 04.11.2025
