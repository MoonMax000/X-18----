# Руководство по диагностике проблемы с комментариями

## Описание проблемы
Пользователь сообщает: "я еще заметил я не могу коментировать чужие посты"

## Что мы уже проверили

### 1. Backend API
- **ОГРАНИЧЕНИЙ НЕТ** - любой авторизованный пользователь может комментировать любой пост
- Код в `custom-backend/internal/api/posts.go` не содержит проверок на владельца поста
- Комментарии правильно исключены из лент (добавлен фильтр `reply_to_id IS NULL`)

### 2. Frontend компонент UnifiedPostDetail.tsx
- Форма комментирования показывается если есть `user` (текущий пользователь)
- НЕТ условий типа `isOwnPost` для скрытия формы
- Кнопка "Reply" отключается только если комментарий пустой

## Как диагностировать проблему

### 1. Запустите тест API
```bash
chmod +x test-commenting.sh
./test-commenting.sh
```

Этот скрипт:
- Создаст пост от user1
- Попробует прокомментировать его от user2
- Проверит, что комментарий не появился в ленте
- Проверит, что комментарий есть в ответах на пост

### 2. Проверьте через браузер
1. Откройте DevTools (F12)
2. Перейдите на вкладку Network
3. Попробуйте прокомментировать чужой пост
4. Посмотрите:
   - Отправляется ли POST запрос на `/api/posts/`?
   - Какой статус ответа (200, 401, 403, 500)?
   - Что в теле ответа?

### 3. Проверьте консоль браузера
- Есть ли JavaScript ошибки?
- Есть ли сообщения об ошибках от React?

### 4. Проверьте UI
- Видна ли форма комментирования на чужих постах?
- Если нет - проверьте, залогинены ли вы (есть ли `user` в AuthContext)
- Если да - что происходит при нажатии кнопки "Reply"?

## Возможные причины

### 1. Проблема с аутентификацией
- Токен истек
- Токен не передается в заголовках
- Проблема с refresh токеном

### 2. Проблема с UI
- Форма условно скрыта где-то выше по иерархии компонентов
- Обработчик onSubmit не срабатывает
- Ошибка при формировании запроса

### 3. Проблема с данными
- `reply_to_id` не передается правильно
- Проблема с форматом UUID
- Ошибка валидации на backend

## Что проверить в коде

### Frontend
1. `client/components/PostCard/UnifiedPostDetail.tsx` - линия ~500
   ```jsx
   {user && (
     <div className="rounded-2xl border...">
       // Форма комментирования
     </div>
   )}
   ```

2. Функция `handleSubmitComment` - проверьте:
   - Вызывается ли она?
   - Что передается в `customBackendAPI.createPost`?
   - Обрабатываются ли ошибки?

### Логи для добавления
Добавьте временные логи в `handleSubmitComment`:
```jsx
console.log('Submitting comment:', {
  content: commentText.trim(),
  reply_to_id: post.id,
});

try {
  const response = await customBackendAPI.createPost({
    content: commentText.trim(),
    reply_to_id: post.id,
  });
  console.log('Comment created:', response);
} catch (error) {
  console.error('Failed to post comment:', error);
  // Покажите ошибку пользователю!
}
```

## Решение (если проблема подтвердится)

Если API работает (тест проходит), но UI не работает:

1. Добавьте обработку ошибок с показом пользователю:
```jsx
const [commentError, setCommentError] = useState("");

const handleSubmitComment = async () => {
  setCommentError("");
  try {
    // ... код создания комментария
  } catch (error) {
    setCommentError(error.message || "Не удалось отправить комментарий");
    console.error('Comment error:', error);
  }
};

// В JSX:
{commentError && (
  <div className="text-red-500 text-sm mt-2">{commentError}</div>
)}
```

2. Убедитесь, что форма не скрыта условиями
3. Проверьте, что `post.id` корректный UUID

## Дальнейшие шаги

1. Запустите тест `test-commenting.sh`
2. Если тест проходит - проблема в UI
3. Если тест не проходит - смотрите ответ сервера
4. Добавьте логи и обработку ошибок как описано выше
5. Проверьте через браузер с открытыми DevTools

Эта информация поможет точно локализовать проблему.
