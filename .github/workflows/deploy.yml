name: Deploy to AWS

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: tyriantrade/backend
  ECS_SERVICE: tyriantrade-backend-service
  ECS_CLUSTER: tyriantrade-cluster
  ECS_TASK_DEFINITION: tyriantrade-backend
  S3_BUCKET: tyriantrade-frontend
  CLOUDFRONT_DISTRIBUTION_ID: E2V60CFOUD2P7L

jobs:
  deploy-backend:
    name: Deploy Backend to ECS
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
        GOPROXY: https://proxy.golang.org,direct
      run: |
        cd custom-backend
        
        # Enable BuildKit for faster builds
        export DOCKER_BUILDKIT=1
        
        # Build with cache from previous builds
        docker buildx build \
          --platform linux/amd64 \
          --cache-from=$ECR_REGISTRY/$ECR_REPOSITORY:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          --push \
          .
        
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Download task definition
      run: |
        aws ecs describe-task-definition \
          --task-definition $ECS_TASK_DEFINITION \
          --query taskDefinition > task-definition.json

    - name: Fill in the new image ID in the Amazon ECS task definition
      id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with:
        task-definition: task-definition.json
        container-name: backend
        image: ${{ steps.build-image.outputs.image }}

    - name: Deploy Amazon ECS task definition
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        task-definition: ${{ steps.task-def.outputs.task-definition }}
        service: ${{ env.ECS_SERVICE }}
        cluster: ${{ env.ECS_CLUSTER }}
        wait-for-service-stability: false
        wait-for-minutes: 10

  deploy-frontend:
    name: Deploy Frontend to S3/CloudFront
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Install dependencies
      run: pnpm install

    - name: Build frontend
      run: |
        echo "üì¶ Copying production environment file..."
        cp client/.env.aws.production .env.production
        cat .env.production
        echo ""
        echo "üî® Building frontend..."
        pnpm run build:client

    - name: Verify build output
      run: |
        echo "üìÅ Checking build output structure..."
        echo "=== Root dist/ directory ==="
        ls -la dist/
        echo ""
        echo "=== dist/spa/ directory ==="
        if [ -d "dist/spa" ]; then
          ls -la dist/spa/
          echo ""
          echo "‚úÖ dist/spa exists with $(find dist/spa -type f | wc -l) files"
        else
          echo "‚ùå dist/spa not found!"
          echo ""
          echo "=== Contents of dist/ ==="
          find dist -type f
          exit 1
        fi

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to S3
      run: |
        if [ -d "dist/spa" ]; then
          aws s3 sync dist/spa/ s3://$S3_BUCKET/ --delete --cache-control "public, max-age=31536000, immutable" --exclude "index.html"
          aws s3 cp dist/spa/index.html s3://$S3_BUCKET/index.html --cache-control "public, max-age=0, must-revalidate"
          echo "‚úÖ Frontend deployed successfully"
        else
          echo "‚ùå Error: dist/spa directory not found!"
          exit 1
        fi

    - name: Invalidate CloudFront
      run: |
        aws cloudfront create-invalidation \
          --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
          --paths "/*"
