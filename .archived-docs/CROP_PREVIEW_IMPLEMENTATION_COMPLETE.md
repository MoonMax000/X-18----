# Crop Preview Implementation - Complete ‚úÖ

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–µ–≤—å—é –æ–±—Ä–µ–∑–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ –æ–∫–Ω–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞. –•–æ—Ç—è –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –±—ç–∫–µ–Ω–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–µ–∑–∞–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–µ–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–µ–∑–∫–∏ –¥–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.

## –†–µ—à–µ–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–≤—å—é –æ–±—Ä–µ–∑–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Canvas API.

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ù–æ–≤–∞—è —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–µ–∑–∫–æ–π (`client/lib/crop-utils.ts`)

```typescript
/**
 * –°–æ–∑–¥–∞–µ—Ç –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
 * –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±—Ä–µ–∑–∫–∏
 */
export async function getCroppedImg(
  imageSrc: string,
  pixelCrop: { x: number; y: number; width: number; height: number },
): Promise<string>
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –°–æ–∑–¥–∞–µ—Ç canvas —Å —Ä–∞–∑–º–µ—Ä–æ–º –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
- –†–∏—Å—É–µ—Ç —Ç–æ–ª—å–∫–æ –æ–±—Ä–µ–∑–∞–Ω–Ω—É—é —á–∞—Å—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ blob URL –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise —Å URL –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `createImage()` - —Å–æ–∑–¥–∞–µ—Ç HTMLImageElement –∏–∑ URL
- `revokeCroppedImg()` - –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç blob URL –∏–∑ –ø–∞–º—è—Ç–∏

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ç–∏–ø MediaItem (`client/components/CreatePostBox/types.ts`)

```typescript
export type MediaItem = {
  id: string;
  url: string;
  type: "image" | "video" | "gif";
  alt?: string;
  transform?: CropTransform;
  sensitiveTags?: string[];
  file?: File;
  // URL –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–≤—å—é (blob URL)
  croppedPreviewUrl?: string;
};
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ MediaEditor (`client/components/CreatePostBox/MediaEditor.tsx`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ handleSave:**
```typescript
const handleSave = async () => {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–µ –ø—Ä–µ–≤—å—é-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  let croppedPreviewUrl: string | undefined;
  try {
    croppedPreviewUrl = await getCroppedImg(media.url, {
      x: croppedAreaPixels.x,
      y: croppedAreaPixels.y,
      width: croppedAreaPixels.width,
      height: croppedAreaPixels.height,
    });
  } catch (error) {
    console.error('Failed to generate cropped preview:', error);
  }

  // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å—Ç–∞—Ä—ã–π blob URL –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (media.croppedPreviewUrl) {
    revokeCroppedImg(media.croppedPreviewUrl);
  }

  onSave({
    ...media,
    transform: updatedTransform,
    alt: altText,
    sensitiveTags: warnings,
    croppedPreviewUrl,
  });
};
```

### 4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –≤ MediaGrid (`client/components/CreatePostBox/MediaGrid.tsx`)

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏:**
```typescript
// –û—á–∏—â–∞–µ–º blob URLs –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
useEffect(() => {
  return () => {
    media.forEach(item => {
      if (item.croppedPreviewUrl) {
        revokeCroppedImg(item.croppedPreviewUrl);
      }
    });
  };
}, [media]);
```

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**
```typescript
<img
  src={item.croppedPreviewUrl || item.url}
  alt={item.alt || `Media ${index + 1}`}
  // ...
/>
```

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–µ–∑–∫–∏ –∏ –ø—Ä–µ–≤—å—é:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–µ–∑–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ**
   - react-easy-crop –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±—Ä–µ–∑–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö

2. **–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ (Save)**
   - MediaEditor –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–µ –ø—Ä–µ–≤—å—é —á–µ—Ä–µ–∑ Canvas API
   - –°–æ–∑–¥–∞–µ—Ç—Å—è blob URL –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - URL —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ MediaItem.croppedPreviewUrl

3. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ MediaGrid**
   - –ï—Å–ª–∏ –µ—Å—Ç—å croppedPreviewUrl - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–µ –ø—Ä–µ–≤—å—é
   - –ï—Å–ª–∏ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

4. **–û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏**
   - –ü—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤—Å–µ blob URLs –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è
   - –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–≤—å—é —Å—Ç–∞—Ä—ã–π URL –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è

5. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è**
   - –ü—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –±—ç–∫–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±—Ä–µ–∑–∫–∏ (cropRect)
   - –ë—ç–∫–µ–Ω–¥ —Å–æ–∑–¥–∞–µ—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
   - Blob URL —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –ø—Ä–µ–≤—å—é

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

‚úÖ **–¢–æ—á–Ω–æ–µ –ø—Ä–µ–≤—å—é** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - canvas —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ, –ø—Ä–µ–≤—å—é –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ blob URLs –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º–∏ Canvas API
‚úÖ **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –±—ç–∫–µ–Ω–¥–∞** - –ø—Ä–µ–≤—å—é —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É

## –í–∞—Ä–∏–∞–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–ª–∏—Å—å

1. **CSS-—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏** ‚ùå
   - –°–ª–æ–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å —Ç–æ—á–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
   - –ü—Ä–æ–±–ª–µ–º—ã —Å aspect ratio
   - –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤

2. **Canvas-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è** ‚úÖ (–≤—ã–±—Ä–∞–Ω–æ)
   - –¢–æ—á–Ω–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ –ø–∏–∫—Å–µ–ª–µ–π
   - –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
   - –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

3. **–ó–∞–ø—Ä–æ—Å –∫ –±—ç–∫–µ–Ω–¥—É** ‚ùå
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
   - –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏
   - –¢—Ä–µ–±—É–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
3. –ù–∞–∂–º–∏—Ç–µ "Edit" –¥–ª—è –æ–±—Ä–µ–∑–∫–∏
4. –ò–∑–º–µ–Ω–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç (Original/Wide/Square)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
6. **–ü—Ä–µ–≤—å—é –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ**
7. –ò–∑–º–µ–Ω–∏—Ç–µ –æ–±—Ä–µ–∑–∫—É —Å–Ω–æ–≤–∞
8. **–ü—Ä–µ–≤—å—é –¥–æ–ª–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è**

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Canvas API
- `canvas.getContext('2d')` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
- `ctx.drawImage()` - —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–π —á–∞—Å—Ç–∏
- `canvas.toBlob()` - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Blob
- `URL.createObjectURL()` - —Å–æ–∑–¥–∞–Ω–∏–µ blob URL
- `URL.revokeObjectURL()` - –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

### –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- Format: JPEG
- Quality: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å)
- –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
- Blob URLs –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è –ø—Ä–∏:
  - –†–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ MediaGrid
  - –°–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–≤—å—é
  - –£–¥–∞–ª–µ–Ω–∏–∏ –º–µ–¥–∏–∞-—ç–ª–µ–º–µ–Ω—Ç–∞

## –°—Ç–∞—Ç—É—Å

‚úÖ **–ó–∞–≤–µ—Ä—à–µ–Ω–æ:**
- –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±—Ä–µ–∑–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ MediaEditor
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –≤ MediaGrid
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

üéØ **–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ (Original/Wide/Square)
3. –£–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∫–∞—Ö
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏

---

*–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: 27.10.2025*
*–í—Ä–µ–º—è: 17:58 (Asia/Saigon)*
