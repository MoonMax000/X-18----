#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏ admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ production –ë–î –Ω–∞ Railway

echo "üë§ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞..."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Railway CLI
if ! command -v railway &> /dev/null; then
    echo "‚ùå Railway CLI –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo ""
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Railway CLI:"
    echo "  macOS: brew install railway"
    echo "  Windows: npm install -g @railway/cli"
    echo "  Linux: npm install -g @railway/cli"
    echo ""
    exit 1
fi

echo "‚úÖ Railway CLI –æ–±–Ω–∞—Ä—É–∂–µ–Ω"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã
echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Railway..."
railway whoami &> /dev/null
if [ $? -ne 0 ]; then
    echo "‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –≤ Railway"
    echo ""
    echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ: railway login"
    echo ""
    exit 1
fi

echo "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å–≤—è–∑–∞–Ω
echo "üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ —Å –ø—Ä–æ–µ–∫—Ç–æ–º..."
railway status &> /dev/null
if [ $? -ne 0 ]; then
    echo "‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ —Å–≤—è–∑–∞–Ω —Å Railway"
    echo ""
    echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ: railway link"
    echo ""
    exit 1
fi

echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–≤—è–∑–∞–Ω"
echo ""

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
echo "üìß –í–≤–µ–¥–∏—Ç–µ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å admin:"
read -p "Email: " USER_EMAIL

if [ -z "$USER_EMAIL" ]; then
    echo "‚ùå Email –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    exit 1
fi

echo ""
echo "üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å email: $USER_EMAIL"
echo ""

# –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª—å admin
railway run psql \$DATABASE_URL << EOF

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
SELECT id, username, email, role 
FROM users 
WHERE email = '$USER_EMAIL';

-- –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª—å admin
UPDATE users 
SET role = 'admin' 
WHERE email = '$USER_EMAIL';

-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
SELECT id, username, email, role 
FROM users 
WHERE email = '$USER_EMAIL';

EOF

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ –†–æ–ª—å admin —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: $USER_EMAIL"
    echo ""
    echo "üìù –í–∞–∂–Ω–æ:"
    echo "  1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–∑–∞–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞)"
    echo "  2. –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ JWT —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—Å—è —Å –Ω–æ–≤–æ–π —Ä–æ–ª—å—é"
    echo "  3. –¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –ª—é–±—ã–µ –ø–æ—Å—Ç—ã —á–µ—Ä–µ–∑ –º–µ–Ω—é –ø–æ—Å—Ç–∞"
    echo ""
echo "üß™ –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ https://social.tyriantrade.com"
    echo "  2. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —ç—Ç–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º"
    echo "  3. –û—Ç–∫—Ä–æ–π—Ç–µ —á—É–∂–æ–π –ø–æ—Å—Ç"
    echo "  4. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç—Ä–∏ —Ç–æ—á–∫–∏ (‚ãÆ)"
    echo "  5. –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ '–£–¥–∞–ª–∏—Ç—å (admin)'"
    echo ""
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —Ä–æ–ª–∏ admin"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "  - –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ë–î"
    echo ""
    exit 1
fi
