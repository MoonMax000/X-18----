# 🖼️ Хранилище Медиа-файлов: Полное Объяснение

## 📊 Ваша Текущая Ситуация

### Что У Вас Сейчас
```
Railway (Backend):
├── Redis          → Кэш данных
├── Postgres       → База данных (URL, метаданные)
└── X-18----       → Backend сервис

Netlify (Frontend):
└── Static files   → HTML/CSS/JS (НЕ МОЖЕТ хранить загрузки)
```

### Текущая Реализация
Смотрю в код `custom-backend/internal/api/media.go`:
```go
uploadDir := "./storage/media"  // ⚠️ Локальная файловая система
```

**ПРОБЛЕМА:** Файлы сохраняются на диск Railway, но:
- ❌ При рестарте контейнера файлы теряются
- ❌ При масштабировании файлы не синхронизируются между инстансами
- ❌ Нет бэкапов
- ❌ Ограниченное место

---

## ✅ Правильные Решения для Production

### Вариант 1: AWS S3 (Рекомендуется) 💰
**Стоимость:** ~$0.023 за GB в месяц + трафик

**Плюсы:**
- ✅ Надёжность 99.999999999%
- ✅ Автоматические бэкапы
- ✅ CDN интеграция (CloudFront)
- ✅ Версионирование файлов
- ✅ Безлимитное хранилище

**Пример стоимости:**
- 1 GB фото: $0.023/месяц
- 10 GB фото: $0.23/месяц
- 100 GB фото: $2.30/месяц

### Вариант 2: Cloudflare R2 (Дешевле) 💎
**Стоимость:** $0.015 за GB в месяц, БЕЗ платы за трафик!

**Плюсы:**
- ✅ Дешевле чем S3
- ✅ Бесплатный трафик (egress)
- ✅ S3-совместимый API
- ✅ Интеграция с Cloudflare CDN

**Пример стоимости:**
- 1 GB фото: $0.015/месяц
- 10 GB фото: $0.15/месяц
- 100 GB фото: $1.50/месяц

### Вариант 3: Railway Volumes (Временное решение) 📦
**Стоимость:** Включено в Railway

**Плюсы:**
- ✅ Простая настройка
- ✅ Нет дополнительной оплаты
- ✅ Персистентное хранилище

**Минусы:**
- ❌ Нет CDN
- ❌ Медленнее для глобальных пользователей
- ❌ Сложнее масштабировать

---

## 🏗️ Архитектура Хранения

### Как Это Работает
```
┌─────────────┐
│   User      │
│  (Browser)  │
└──────┬──────┘
       │ 1. Upload file
       ▼
┌─────────────────┐
│   Netlify       │
│  (Frontend)     │
└────────┬────────┘
         │ 2. POST /api/media/upload
         ▼
┌──────────────────┐
│  Railway Backend │
│  (API Server)    │
└────────┬─────────┘
         │ 3. Upload to storage
         ▼
┌──────────────────┐     ┌──────────────┐
│  Cloud Storage   │     │  Postgres    │
│  (S3/R2/Volume)  │     │  (Metadata)  │
│  - Actual files  │     │  - URLs      │
│  - Images        │     │  - Sizes     │
│  - Videos        │     │  - User IDs  │
└──────────────────┘     └──────────────┘
```

### Что Хранится Где

**Postgres (База данных):**
```sql
-- Таблица media
id          uuid
user_id     uuid
url         text          -- https://cdn.tyriantrade.com/abc123.jpg
type        varchar       -- image, video, gif
size_bytes  bigint
width       int
height      int
created_at  timestamp
```

**S3/R2/Volume (Файловое хранилище):**
```
storage/
├── media/
│   ├── abc123-def456.jpg
│   ├── ghi789-jkl012.mp4
│   └── thumb_abc123-def456.jpg
```

---

## 🚀 Рекомендация для Вас

### Для Старта (Сейчас)
**Railway Volumes** - простое решение для начала

### Для Production (Позже)
**Cloudflare R2** - лучшее соотношение цена/качество

---

## 📝 План Действий

### Этап 1: Railway Volumes (Быстрый старт)
```bash
# В Railway добавить Volume:
# 1. Зайти в проект X-18----
# 2. Volumes → New Volume
# 3. Mount Path: /app/storage
# 4. Size: 10GB (для начала)
```

### Этап 2: Обновить Backend
Текущий код уже правильный! Просто используется `./storage/media`

### Этап 3: Настроить BASE_URL
В Railway добавить переменную:
```
BASE_URL=https://api.tyriantrade.com
```

### Этап 4: (Опционально) Миграция на S3/R2
Когда проект вырастет, можно перенести на облако.

---

## 💡 Важные Моменты

### 1. Netlify НЕ ХРАНИТ загруженные файлы
Netlify - это статический хостинг:
- ✅ Может отдавать файлы которые вы задеплоили
- ❌ НЕ может сохранять файлы которые пользователи загружают

### 2. Backend на Railway МОЖЕТ хранить файлы
Но только с Volume:
- ❌ БЕЗ Volume: файлы пропадут при рестарте
- ✅ С Volume: файлы сохраняются

### 3. URL файлов
```javascript
// НЕПРАВИЛЬНО:
url: "https://social.tyriantrade.com/uploads/photo.jpg"  // ❌

// ПРАВИЛЬНО:
url: "https://api.tyriantrade.com/storage/media/abc-123.jpg"  // ✅
```

### 4. Отдача файлов
В вашем backend уже есть роут для отдачи:
```go
// GET /storage/media/:filename
app.Static("/storage/media", "./storage/media")
```

---

## 🔧 Что Нужно Сделать Прямо Сейчас

### 1. Создать Volume в Railway
```
1. Открыть Railway → X-18---- проект
2. Вкладка "Variables"
3. Нажать "+ New Variable"
4. Имя: RAILWAY_VOLUME_MOUNT_PATH
5. Значение: /app/storage
```

### 2. Проверить переменную BASE_URL
```
1. В Railway → Variables
2. Добавить: BASE_URL = https://api.tyriantrade.com
```

### 3. Передеплоить backend
После добавления Volume нужен рестарт:
```
Railway → Deployments → Redeploy
```

---

## 📊 Сравнение Вариантов

| Критерий | Railway Volume | Cloudflare R2 | AWS S3 |
|----------|---------------|---------------|---------|
| **Стоимость** | Включено | $0.015/GB | $0.023/GB |
| **Трафик** | Бесплатно | Бесплатно | ~$0.09/GB |
| **CDN** | ❌ | ✅ | ✅ (+$) |
| **Надёжность** | Средняя | Высокая | Очень высокая |
| **Сложность** | Простая | Средняя | Средняя |
| **Для старта** | ✅ | ⚠️ | ⚠️ |
| **Для масштаба** | ❌ | ✅ | ✅ |

---

## 🎯 Мой Совет

**Сейчас:** Используйте Railway Volumes
- Быстро настроить
- Нет дополнительных затрат
- Достаточно для первых пользователей

**Когда масштабируетесь:** Переходите на Cloudflare R2
- Дешевле AWS
- Бесплатный трафик
- Глобальный CDN

**Через год:** Если нужна максимальная надёжность → AWS S3

---

## ❓ Частые Вопросы

**Q: Можно ли хранить в Postgres?**
A: Нет! База данных для метаданных, не для бинарных файлов.

**Q: Можно ли хранить в Redis?**
A: Нет! Redis для кэша, не для постоянного хранения.

**Q: Почему не хранить на Netlify?**
A: Netlify - статический хостинг, не поддерживает загрузки.

**Q: Сколько места нужно в начале?**
A: 5-10 GB достаточно для старта (≈1000 фото в HD).

---

## 📞 Следующие Шаги

Хотите чтобы я:
1. ✅ Настроил Railway Volume прямо сейчас?
2. ✅ Показал как интегрировать Cloudflare R2?
3. ✅ Создал скрипт миграции на S3?

Напишите что вам нужно!
